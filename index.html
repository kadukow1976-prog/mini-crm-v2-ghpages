<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MiniCRM Mobile v2 ‚Äî Android</title>
  <meta name="theme-color" content="#0b0f14" />
  <!-- –õ—ë–≥–∫–∞—è –æ–±–æ–ª–æ—á–∫–∞: –≤—Å—ë —Ç—è–∂—ë–ª–æ–µ –≤—ã–Ω–µ—Å–µ–Ω–æ –≤–æ –≤–Ω–µ—à–Ω–∏–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã —Ö–æ–ª—Å—Ç/–±—Ä–∞—É–∑–µ—Ä –Ω–µ —Ä—É–≥–∞–ª—Å—è –Ω–∞ –¥–ª–∏–Ω—É –¥–æ–∫—É–º–µ–Ω—Ç–∞. -->
  <link rel="preload" href="styles.css" as="style" />
  <link rel="stylesheet" href="styles.css" />
  <!-- PWA manifest + icons -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="icons/icon-192.png" />
  <link rel="icon" sizes="512x512" href="icons/icon-512.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
</head>
<body>
  <noscript>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–∫–ª—é—á–∏—Ç–µ JavaScript.</noscript>
  <div id="app" style="padding:16px;color:#e7eef7;font:16px system-ui;background:#0b0f14;min-height:100dvh">
    –ó–∞–≥—Ä—É–∑–∫–∞ MiniCRM v2‚Ä¶
  </div>
  <!-- –í–Ω–µ—à–Ω–∏–π –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JS. –î–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å index.html –Ω–∞ GitHub Pages. -->
  <script src="app.min.js" defer></script>
  <script>
    // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ app.min.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (–Ω–µ–≤–µ—Ä–Ω—ã–π –ø—É—Ç—å/URL):
    window.addEventListener('load', () => {
      setTimeout(() => {
        if (!window.__MiniCRMv2BootOK) {
          const app = document.getElementById('app');
          app.innerHTML = (
            '<div style="max-width:680px;margin:0 auto">'
            + '<h1 style="margin:0 0 12px">MiniCRM v2 ‚Äî –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç</h1>'
            + '<p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª—ã <code>styles.css</code> –∏ <code>app.min.js</code> —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –≤ —Ç–æ–º –∂–µ –∫–∞—Ç–∞–ª–æ–≥–µ, —á—Ç–æ –∏ <code>index.html</code>, –∏ –ø—É—Ç–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç.</p>"
            + '<ol>'
            + '<li>–û—Ç–∫—Ä–æ–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12) ‚Üí Console: –Ω–µ—Ç –ª–∏ –æ—à–∏–±–æ–∫ 404/–º–æ–¥—É–ª—è?</li>'
            + '<li>–ó–∞–π–¥–∏—Ç–µ –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ: <code>https://–í–ê–®_–Æ–ó–ï–†.github.io/–í–ê–®_–†–ï–ü–û/app.min.js</code> ‚Äî —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è.</li>'
            + '<li>–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, <code>/crm/</code>), –æ–±–Ω–æ–≤–∏—Ç–µ –ø—É—Ç–∏ –≤ index.html: <code>href="/crm/styles.css"</code> –∏ <code>src="/crm/app.min.js"</code>.</li>'
            + '</ol>'
            + '<p style="opacity:.8">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç <code>window.__MiniCRMv2BootOK = true</code>.</p>'
            + '</div>'
          );
        }
      }, 1200);
    });
  </script>
  <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è –æ—Ñ–ª–∞–π–Ω–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js").catch(()=>{});
      });
    }
  </script>

</body>
</html>
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MiniCRM Mobile ‚Äî Android (PWA)</title>
<meta name="theme-color" content="#0c0f14">
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" sizes="512x512" href="icons/icon-512.png">
<style>
/* ===== MIUI‚Äë–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç—ë–º–Ω—ã–π UI –¥–ª—è Android ===== */
:root{
  --bg:#0c0f14; --panel:#11161f; --soft:#0f141c; --border:#1d2632;
  --text:#e8eef6; --dim:#9aa8bf; --accent:#19c37d; --danger:#ff5d5d;
  --warn:#ffb020; --ok:#2ecc71; --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.35);
  --glass:rgba(255,255,255,.04);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:linear-gradient(180deg,var(--bg),#0a0e13 50%,#0a0d12);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell}

/* –®–∞–ø–∫–∞ */
.header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(12,15,20,.95),rgba(12,15,20,.75));backdrop-filter:saturate(120%) blur(8px);padding:10px 12px;border-bottom:1px solid var(--border)}
.brand{display:flex;align-items:center;gap:10px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#40ffb4,var(--accent));box-shadow:0 0 16px var(--accent)}
.brand h1{font-size:16px;margin:0;font-weight:600}

/* –ü–æ–∏—Å–∫ */
.search{margin-top:10px;display:flex;gap:8px}
.search input{flex:1;background:var(--soft);border:1px solid var(--border);color:var(--text);padding:12px 12px;border-radius:12px;outline:none}
.search input::placeholder{color:var(--dim)}
.search .badge{white-space:nowrap;border:1px dashed var(--border);padding:10px 12px;border-radius:12px;color:var(--dim)}

/* –ü–µ–π–¥–∂–µ—Ä */
.tabs{position:sticky;top:72px;z-index:4;display:flex;gap:8px;overflow:auto;padding:8px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(15,20,28,.9),rgba(15,20,28,.6))}
.tab{flex:0 0 auto;padding:10px 14px;border-radius:999px;background:var(--glass);border:1px solid var(--border);color:var(--dim)}
.tab.active{color:var(--text);background:linear-gradient(180deg,rgba(25,195,125,.15),rgba(25,195,125,.08));border-color:rgba(25,195,125,.35);box-shadow:0 4px 18px rgba(25,195,125,.15)}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü —Å–æ —Å–≤–∞–π–ø–æ–º */
.pages{position:relative;overflow:hidden}
.page{min-height:calc(100dvh - 150px);padding:14px;display:none}
.page.active{display:block;animation:fade .18s}
@keyframes fade{from{opacity:.5;transform:translateY(4px)}to{opacity:1;transform:none}}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ */
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin:10px 0;padding:12px}
.card .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.card .title{font-weight:600}
.card .muted{color:var(--dim)}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.chip{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--dim)}
.chip.positive{color:#b8f7d9;border-color:rgba(25,195,125,.4)}
.chip.warn{color:#ffe0ad;border-color:rgba(255,176,32,.4)}
.chip.danger{color:#ffb8b8;border-color:rgba(255,93,93,.4)}

.actions{display:flex;gap:8px;margin-top:10px}
.btn{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);text-align:center}
.btn.primary{background:linear-gradient(180deg,#1dd488,#19c37d);border-color:#19c37d;color:#062e1e;font-weight:700}
.btn.danger{background:linear-gradient(180deg,#ff7b7b,#ff5d5d);border-color:#ff5d5d;color:#2b0707;font-weight:700}
.btn.ghost{background:var(--soft)}

/* –§–æ—Ä–º–∞ –∫–ª–∏–µ–Ω—Ç–∞ */
.form{display:grid;gap:10px}
.field{display:grid;gap:6px}
.field label{font-size:13px;color:var(--dim)}
.field input,.field textarea,.field select{padding:12px;background:var(--soft);border:1px solid var(--border);border-radius:12px;color:var(--text);outline:none}
.field textarea{min-height:80px;resize:vertical}

/* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
.navbar{position:sticky;bottom:0;z-index:3;background:linear-gradient(0deg,rgba(9,12,16,.95),rgba(9,12,16,.75));backdrop-filter:blur(8px);border-top:1px solid var(--border);padding:10px}
.navrow{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.navbtn{padding:10px;border-radius:12px;background:var(--glass);border:1px solid var(--border);color:var(--dim);text-align:center}
.navbtn.active{color:var(--text);border-color:rgba(25,195,125,.35);box-shadow:0 4px 18px rgba(25,195,125,.15)}

/* –†–µ–π—Ç–∏–Ω–≥ */
.stars{display:flex;gap:6px}
.star{font-size:20px;cursor:pointer;filter:drop-shadow(0 2px 4px rgba(0,0,0,.4))}
.star.filled{color:#ffd45b}

/* –ü–ª–∞—à–∫–∏ —Å—É–º–º */
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.kpi{background:linear-gradient(180deg,rgba(25,195,125,.12),rgba(25,195,125,.04));border:1px solid rgba(25,195,125,.35);border-radius:14px;padding:12px}
.kpi h3{margin:0 0 6px 0;font-size:13px;color:var(--dim)}
.kpi b{font-size:18px}

.small{font-size:12px;color:var(--dim)}
.phone{color:#b8f7d9;text-decoration:none}

/* –ü–æ–¥—Å–∫–∞–∑–∫–∏ */
.toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:#111;opacity:0;color:#fff;border:1px solid #333;padding:10px 12px;border-radius:10px;transition:.2s;pointer-events:none}
.toast.show{opacity:1}

/* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ (–ø–æ–¥—Å–≤–µ—Ç–∫–∞) */
.tab::after{content:"";display:block;height:2px;border-radius:2px;background:transparent;margin-top:6px}
.tab.active::after{background:radial-gradient(60% 60% at 50% 50%, var(--accent), transparent)}
</style>
</head>
<body>
  <div class="header">
    <div class="brand"><div class="dot"></div><h1>MiniCRM ‚Äî –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è</h1></div>
    <div class="search">
      <input id="q" placeholder="–ü–æ–∏—Å–∫: –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –º–æ–¥–µ–ª—å, #ID‚Ä¶ (–ø–æ –±—É–∫–≤–∞–º/—Ü–∏—Ñ—Ä–∞–º)" autocomplete="off">
      <div class="badge" id="stat">0 –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
    <button class="tab" data-page="debts">–î–æ–ª–∂–Ω–∏–∫–∏</button>
    <button class="tab" data-page="work">–í —Ä–∞–±–æ—Ç–µ</button>
    <button class="tab" data-page="done">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
    <button class="tab" data-page="edit">–ù–æ–≤—ã–π/–ü—Ä–∞–≤–∫–∞</button>
    <button class="tab" data-page="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>

  <div class="pages" id="pages">
    <!-- –ì–ª–∞–≤–Ω–∞—è: —Å–≤–æ–¥–∫–∞ –∏ —Å–ø–∏—Å–æ–∫ -->
    <section class="page active" id="page-home">
      <div class="kpis" id="home-kpis"></div>
      <div id="home-list"></div>
    </section>

    <!-- –î–æ–ª–∂–Ω–∏–∫–∏: –µ–¥–∏–Ω–∞—è —Å–≤–æ–¥–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ + —Å–ø–∏—Å–æ–∫ -->
    <section class="page" id="page-debts">
      <div id="debts-summary"></div>
      <div id="debts-list"></div>
    </section>

    <!-- –í —Ä–∞–±–æ—Ç–µ -->
    <section class="page" id="page-work">
      <div id="work-list"></div>
    </section>

    <!-- –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ -->
    <section class="page" id="page-done">
      <div id="done-list"></div>
    </section>

    <!-- –§–æ—Ä–º–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
    <section class="page" id="page-edit">
      <form class="form" id="form">
        <input type="hidden" id="f-id">
        <div class="field"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input id="f-name" required></div>
        <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="f-phone" inputmode="tel" placeholder="+7‚Ä¶"></div>
        <div class="field"><label>–ú–æ–¥–µ–ª—å –∞–ø–ø–∞—Ä–∞—Ç–∞</label><input id="f-device"></div>
        <div class="field"><label>–ü—Ä–æ–±–ª–µ–º–∞</label><textarea id="f-issue"></textarea></div>

        <div class="field"><label>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã ‚ÇΩ</label><input id="f-labor" type="number" inputmode="numeric" value="0"></div>
        <div class="field"><label>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—á–∞—Å—Ç–µ–π ‚ÇΩ</label><input id="f-parts" type="number" inputmode="numeric" value="0"></div>
        <div class="field"><label>–û–ø–ª–∞—á–µ–Ω–æ ‚ÇΩ</label><input id="f-paid" type="number" inputmode="numeric" value="0"></div>
        <div class="field"><label>–°—Ç–∞—Ç—É—Å</label>
          <select id="f-status">
            <option value="work">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
          </select>
        </div>
        <div class="field"><label>–ó–∞–º–µ—Ç–∫–∞ –º–∞—Å—Ç–µ—Ä–∞</label><textarea id="f-notes"></textarea></div>

        <div class="field"><label>–†–µ–π—Ç–∏–Ω–≥ –∫–ª–∏–µ–Ω—Ç–∞</label>
          <div class="stars" id="f-stars"></div>
          <div class="small">–∫–∞—Å–Ω–∏—Å—å –Ω—É–∂–Ω–æ–π –∑–≤–µ–∑–¥—ã</div>
        </div>

        <div class="actions">
          <button type="button" class="btn ghost" id="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn primary" id="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <button type="button" class="btn danger" id="btn-delete" style="margin-top:6px">–£–¥–∞–ª–∏—Ç—å</button>
      </form>
    </section>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏/–æ–Ω–ª–∞–π–Ω -->
    <section class="page" id="page-settings">
      <div class="card">
        <div class="title">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</div>
        <div class="field" style="margin-top:10px">
          <label>API URL (Apps Script Web App)</label>
          <input id="cfg-api" placeholder="https://script.google.com/macros/s/XXX/exec">
        </div>
        <div class="field">
          <label>–†–µ–∂–∏–º</label>
          <select id="cfg-mode">
            <option value="offline-first">Offline‚Äëfirst (–ª–æ–∫–∞–ª—å–Ω–æ ‚Üí —Å–µ—Ä–≤–µ—Ä)</option>
            <option value="online-preferred">–û–Ω–ª–∞–π–Ω‚Äë–≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ</option>
          </select>
        </div>
        <div class="actions">
          <button class="btn" id="btn-save-config">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button class="btn primary" id="btn-sync-now">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div class="small" id="sync-log" style="margin-top:8px;color:var(--dim)"></div>
      </div>
      <div class="card">
        <div class="title">PWA</div>
        <div class="chips">
          <span class="chip">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –î–æ–º–æ–π</span>
          <span class="chip">–†–∞–±–æ—Ç–∞ –±–µ–∑ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–∞</span>
          <span class="chip">–ö—ç—à —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤</span>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="btn-install">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
          <button class="btn" id="btn-clear-cache">–°–±—Ä–æ—Å –∫—ç—à–∞</button>
        </div>
      </div>
    </section>
  </div>

  <div class="navbar" id="navbar">
    <div class="navrow">
      <button class="navbtn active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="navbtn" data-page="debts">–î–æ–ª–≥–∏</button>
      <button class="navbtn" data-page="work">–í —Ä–∞–±–æ—Ç–µ</button>
      <button class="navbtn" data-page="edit">–ù–æ–≤—ã–π</button>
      <button class="navbtn" data-page="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </div>

  <div class="toast" id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

<script>
// ===== –•–µ–ª–ø–µ—Ä—ã DOM –∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ =====
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const byId = id => document.getElementById(id);
const safeOn = (el, type, handler, opts) => { if(el) el.addEventListener(type, handler, opts); };

// ===== –õ–æ–∫–∞–ª—å–Ω–æ–µ ¬´—Ö—Ä–∞–Ω–∏–ª–∏—â–µ¬ª =====
const key = 'miniCRM.v1';
const cfgKey = 'miniCRM.config.v1';
const queueKey = 'miniCRM.queue.v1';
const db = {
  get(){ try{ return JSON.parse(localStorage.getItem(key)) || [] }catch(e){ return [] }},
  set(list){ localStorage.setItem(key, JSON.stringify(list)); }
};
const cfg = {
  get(){ try{ return JSON.parse(localStorage.getItem(cfgKey)) || { apiUrl:'', mode:'offline-first' } }catch(e){ return { apiUrl:'', mode:'offline-first' } } },
  set(v){ localStorage.setItem(cfgKey, JSON.stringify(v)); }
};
const opQueue = {
  get(){ try{ return JSON.parse(localStorage.getItem(queueKey)) || [] }catch(e){ return [] } },
  set(v){ localStorage.setItem(queueKey, JSON.stringify(v)); },
  push(op){ const q=this.get(); q.push({...op, ts:Date.now()}); this.set(q); }
};

// ===== –£—Ç–∏–ª–∏—Ç—ã =====
const fmt = n => new Intl.NumberFormat('ru-RU').format(Math.round(Number(n||0)));
const money = n => (fmt(n) + ' ‚ÇΩ');
const nowId = () => '#' + Math.floor(100000 + Math.random()*899999);
function compute(item){
  const labor = +item.labor||0, parts = +item.parts||0, paid = +item.paid||0;
  const total = labor + parts;
  const debt = Math.max(0, total - paid);
  const rest = Math.max(0, paid - total) > 0 ? 0 : (total - paid);
  return { total, debt, rest };
}
function toast(msg){
  const t = byId('toast');
  if(!t) return; t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1400);
}

// ===== –î–µ–º–æ‚Äë–¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –ø—É—Å—Ç–æ) =====
(function seed(){
  if(db.get().length) return;
  const sample = [
    {id:nowId(), name:'–ê–ª–µ–∫—Å–µ–π –°–º–∏—Ä–Ω–æ–≤', phone:'+7 900 123‚Äë45‚Äë67', device:'iPhone 11', issue:'–ó–∞–º–µ–Ω–∞ –¥–∏—Å–ø–ª–µ—è', labor:2500, parts:3500, paid:3000, status:'work', notes:'–û–∂–∏–¥–∞–µ–º –∑–∞–ø—á–∞—Å—Ç—å', rating:4, createdAt:Date.now()-86400000*2},
    {id:nowId(), name:'–ò—Ä–∏–Ω–∞ –ö–∞–¥–æ–º—Ü–µ–≤–∞', phone:'+7 915 222‚Äë00‚Äë11', device:'Redmi Note 10', issue:'–ê–ö–ë + —á–∏—Å—Ç–∫–∞', labor:1800, parts:1200, paid:2000, status:'done', notes:'–í—ã–¥–∞–Ω 31.10', rating:5, createdAt:Date.now()-86400000*3},
    {id:nowId(), name:'–°—Ç–∞—Å –ü–µ—Ç—Ä–æ–≤', phone:'+7 901 555‚Äë77‚Äë88', device:'Realme C61', issue:'–ó–∞–º–µ–Ω–∞ —Å–µ–Ω—Å–æ—Ä–∞', labor:2200, parts:1900, paid:500, status:'work', notes:'–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏–ª –∑–≤–æ–Ω–æ–∫', rating:3, createdAt:Date.now()-86400000}
  ];
  db.set(sample);
})();

// ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ UI =====
let state = { page:'home', query:'', editId:null, stars:0 };
let refs = {};

// ===== –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏–∫–∞ =====
function matchQuery(item, q){
  if(!q) return true; q=q.toLowerCase();
  const src = [item.name, item.phone, item.device, item.id].join(' ').toLowerCase().replaceAll(/[\s\-()]/g,'');
  const compactQ = q.toLowerCase().replaceAll(/[\s\-()]/g,'');
  return src.includes(compactQ) || src.startsWith(compactQ);
}

function aggregate(list){
  let totalDebt=0,totalPaid=0,totalSum=0,inWork=0,done=0, debtors=0;
  list.forEach(x=>{
    const m=compute(x); totalDebt+=m.debt; totalPaid+=+x.paid||0; totalSum+=m.total; inWork+= x.status==='work'?1:0; done+= x.status==='done'?1:0; if(m.debt>0) debtors++;
  });
  return {totalDebt,totalPaid,totalSum,inWork,done,debtors,count:list.length};
}

function renderKpis(list){
  const a=aggregate(list);
  const kpis = byId('home-kpis');
  if(!kpis) return;
  kpis.innerHTML = `
    <div class="kpi"><h3>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3><b>${a.count}</b><div class="small">–í —Ä–∞–±–æ—Ç–µ: ${a.inWork} ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${a.done}</div></div>
    <div class="kpi"><h3>–§–∏–Ω–∞–Ω—Å—ã</h3><b>${money(a.totalPaid)} / ${money(a.totalSum)}</b><div class="small">–î–æ–ª–≥ –æ–±—â–∏–π: <b style="color:var(--warn)">${money(a.totalDebt)}</b></div></div>
  `;
}

function card(item){
  const m = compute(item);
  const debtChip = m.debt>0 ? `<span class="chip danger">–î–æ–ª–≥: ${money(m.debt)}</span>` : `<span class="chip positive">–û–ø–ª–∞—á–µ–Ω–æ: ${money(item.paid||0)}</span>`;
  const statusChip = item.status==='done' ? `<span class="chip positive">–ó–∞–≤–µ—Ä—à—ë–Ω</span>` : `<span class="chip warn">–í —Ä–∞–±–æ—Ç–µ</span>`;
  const stars = '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.split('').map((s,i)=>`<span class="star ${i< (item.rating||0) ? 'filled':''}" aria-hidden="true">‚òÖ</span>`).join('');
  return `
    <div class="card" data-id="${item.id}">
      <div class="row">
        <div class="title">${item.name} <span class="muted">${item.id}</span></div>
        <div class="stars" aria-hidden="true">${stars}</div>
      </div>
      <div class="row small" style="margin-top:6px">
        <a class="phone" href="tel:${(item.phone||'').replace(/[^\d+]/g,'')}">üìû ${item.phone||''}</a>
        <span>‚Ä¢ ${item.device||''}</span>
      </div>
      <div class="chips">
        <span class="chip">–†–∞–±–æ—Ç–∞: ${money(item.labor||0)}</span>
        <span class="chip">–î–µ—Ç–∞–ª–∏: ${money(item.parts||0)}</span>
        <span class="chip">–ò—Ç–æ–≥–æ: ${money(m.total)}</span>
        ${debtChip}
        ${statusChip}
      </div>
      <div class="actions">
        <button class="btn" data-act="call">–í—ã–∑–≤–∞—Ç—å</button>
        <button class="btn" data-act="done">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        <button class="btn primary" data-act="edit">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
    </div>`;
}

function empty(msg){ return `<div class="card"><div class="muted">${msg}</div></div>`; }

function renderLists(){
  const list = db.get();
  const filtered = list.filter(x=>matchQuery(x, state.query));
  const statEl = byId('stat'); if(statEl) statEl.textContent = `${filtered.length} –∫–ª–∏–µ–Ω—Ç–æ–≤`;
  renderKpis(filtered);
  const home = byId('home-list');
  if(home) home.innerHTML = filtered.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)).map(card).join('') || empty('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞.');
  const debtOnly = filtered.filter(x=>compute(x).debt>0);
  const sumDebt = debtOnly.reduce((s,x)=>s+compute(x).debt,0);
  const debSum = byId('debts-summary');
  if(debSum) debSum.innerHTML = `
    <div class="card">
      <div class="title">–î–æ–ª–∂–Ω–∏–∫–∏ ‚Äî —Å–≤–æ–¥–∫–∞</div>
      <div class="chips">
        <span class="chip danger">–í—Å–µ–≥–æ –¥–æ–ª–≥: ${money(sumDebt)}</span>
        <span class="chip">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${debtOnly.length}</span>
      </div>
      <div class="small" style="margin-top:6px">–≠—Ç–æ ¬´–µ–¥–∏–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞¬ª –ø–æ –≤—Å–µ–º –¥–æ–ª–∂–Ω–∏–∫–∞–º. –ù–∏–∂–µ ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞–∂–¥–æ–º—É.</div>
    </div>`;
  const debList = byId('debts-list');
  if(debList) debList.innerHTML = debtOnly.map(card).join('') || empty('–ù–µ—Ç –¥–æ–ª–∂–Ω–∏–∫–æ–≤ üéâ');
  const workList = byId('work-list');
  if(workList) workList.innerHTML = filtered.filter(x=>x.status==='work').map(card).join('') || empty('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–±–æ—Ç');
  const doneList = byId('done-list');
  if(doneList) doneList.innerHTML = filtered.filter(x=>x.status==='done').map(card).join('') || empty('–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö');
}

function renderStars(container, value){
  if(!container) return;
  container.innerHTML = '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.split('').map((s,i)=>`<span class="star ${i<value?'filled':''}" data-val="${i+1}">‚òÖ</span>`).join('');
}

function fillForm(id){
  const form = byId('form'); if(!form) return;
  const delBtn = byId('btn-delete');
  const fields = {
    id: byId('f-id'), name:byId('f-name'), phone:byId('f-phone'),
    device:byId('f-device'), issue:byId('f-issue'), labor:byId('f-labor'),
    parts:byId('f-parts'), paid:byId('f-paid'), status:byId('f-status'),
    notes:byId('f-notes')
  };
  const starsEl = byId('f-stars');

  if(!id){
    form.reset(); state.stars=0; renderStars(starsEl, 0); if(delBtn) delBtn.style.display='none';
    return;
  }
  const item = db.get().find(x=>x.id===id); if(!item){ form.reset(); renderStars(starsEl, 0); return; }
  if(fields.id) fields.id.value=item.id;
  if(fields.name) fields.name.value=item.name||'';
  if(fields.phone) fields.phone.value=item.phone||'';
  if(fields.device) fields.device.value=item.device||'';
  if(fields.issue) fields.issue.value=item.issue||'';
  if(fields.labor) fields.labor.value=item.labor||0;
  if(fields.parts) fields.parts.value=item.parts||0;
  if(fields.paid) fields.paid.value=item.paid||0;
  if(fields.status) fields.status.value=item.status||'work';
  if(fields.notes) fields.notes.value=item.notes||'';
  state.stars = item.rating||0; renderStars(starsEl, state.stars);
  if(delBtn) delBtn.style.display='block';
}

function go(page){ state.page = page; updateNavUI(); renderLists(); if(page==='edit') fillForm(state.editId); if(page==='settings') loadConfigUI(); }

function updateNavUI(){
  $$('.tab').forEach(b=> b.classList.toggle('active', b.dataset.page===state.page));
  $$('.navbtn').forEach(b=> b.classList.toggle('active', b.dataset.page===state.page));
  $$('.page').forEach(p=> p.classList.toggle('active', p.id===`page-${state.page}`));
}

// ===== –û–Ω–ª–∞–π–Ω —Å–∏–Ω–∫ (–∑–∞–≥–ª—É—à–∫–∞ + –æ—á–µ—Ä–µ–¥—å) =====
async function syncNow(){
  const conf = cfg.get();
  const log = byId('sync-log'); if(log) log.textContent = '–ò–¥—ë—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è‚Ä¶';
  if(!conf.apiUrl){
    if(log) log.textContent = 'API URL –Ω–µ –∑–∞–¥–∞–Ω. –°–æ—Ö—Ä–∞–Ω–∏ –∞–¥—Ä–µ—Å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.';
    toast('–£–∫–∞–∂–∏ API URL');
    return;
  }
  try{
    const listRes = await fetch(conf.apiUrl + '?action=list', {cache:'no-store'});
    if(listRes.ok){
      const payload = await listRes.json().catch(()=>null);
      if(Array.isArray(payload)){
        db.set(payload);
      }
    }
    const q = opQueue.get();
    if(q.length){
      const postRes = await fetch(conf.apiUrl + '?action=apply', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(q)
      });
      if(postRes.ok){ opQueue.set([]); }
    }
    renderLists();
    if(log) log.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.';
    toast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  }catch(e){
    if(log) log.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏/—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
    console.error(e);
    toast('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
  }
}

function loadConfigUI(){
  const conf = cfg.get();
  const api = byId('cfg-api'); const mode = byId('cfg-mode');
  if(api) api.value = conf.apiUrl || '';
  if(mode) mode.value = conf.mode || 'offline-first';
}

function saveConfig(){
  const api = byId('cfg-api')?.value?.trim() || '';
  const mode = byId('cfg-mode')?.value || 'offline-first';
  cfg.set({ apiUrl: api, mode });
  toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}

function recordOp(type, data){
  opQueue.push({ type, data });
}

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ =====
function init(){
  refs = {
    pagesEl: byId('pages'),
    tabsEl: byId('tabs'),
    navbar: byId('navbar'),
    qEl: byId('q')
  };

  // –ü–æ–∏—Å–∫
  safeOn(refs.qEl, 'input', ()=>{ state.query = refs.qEl.value.trim(); renderLists(); });

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è
  const navHandler = (e)=>{
    const btn = e.target.closest('[data-page]'); if(!btn) return;
    const page = btn.getAttribute('data-page');
    if(page==='edit') state.editId=null;
    go(page);
  };
  safeOn(refs.tabsEl, 'click', navHandler);
  safeOn(refs.navbar, 'click', navHandler);

  // –°–≤–∞–π–ø—ã
  let touchX=null; const order=['home','debts','work','done','edit','settings'];
  safeOn(refs.pagesEl,'touchstart',e=>{touchX=e.changedTouches[0].clientX});
  safeOn(refs.pagesEl,'touchend',e=>{
    if(touchX==null) return; const dx=e.changedTouches[0].clientX - touchX; touchX=null;
    if(Math.abs(dx)<50) return;
    let idx = order.indexOf(state.page);
    if(dx<0 && idx<order.length-1) go(order[idx+1]);
    if(dx>0 && idx>0) go(order[idx-1]);
  });

  // –ö–∞—Ä—Ç–æ—á–∫–∏ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
  safeOn(refs.pagesEl,'click',(e)=>{
    const card = e.target.closest('.card');
    if(!card) return;
    const id = card.dataset.id;
    if(e.target.closest('[data-act="edit"]')){ state.editId=id; go('edit'); return; }
    if(e.target.closest('[data-act="done"]')){
      let list=db.get(); const i=list.findIndex(x=>x.id===id);
      if(i>-1){ list[i].status='done'; db.set(list); recordOp('update',{id, status:'done'}); toast('–û—Ç–º–µ—á–µ–Ω–æ ¬´–ó–∞–≤–µ—Ä—à—ë–Ω¬ª'); renderLists(); }
      return;
    }
    if(e.target.closest('[data-act="call"]')){
      const item = db.get().find(x=>x.id===id);
      if(item){ window.location.href = 'tel:'+ (item.phone||'').replace(/[^\d+]/g,''); }
      return;
    }
    if(!e.target.closest('.btn')){ state.editId=id; go('edit'); }
  });

  // –†–µ–π—Ç–∏–Ω–≥
  safeOn(byId('page-edit'), 'click', (e)=>{
    const star = e.target.closest('#f-stars .star'); if(!star) return;
    const val = +star.dataset.val || 0;
    state.stars = val; renderStars(byId('f-stars'), state.stars);
  });

  // –§–æ—Ä–º–∞: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å/–æ—Ç–º–µ–Ω–∞
  const form = byId('form');
  safeOn(form, 'submit', (e)=>{
    e.preventDefault();
    const fields = {
      id: byId('f-id'), name:byId('f-name'), phone:byId('f-phone'),
      device:byId('f-device'), issue:byId('f-issue'), labor:byId('f-labor'),
      parts:byId('f-parts'), paid:byId('f-paid'), status:byId('f-status'),
      notes:byId('f-notes')
    };
    const payload = {
      id: (fields.id && fields.id.value) || nowId(),
      name: (fields.name && fields.name.value.trim()) || '',
      phone: (fields.phone && fields.phone.value.trim()) || '',
      device: (fields.device && fields.device.value.trim()) || '',
      issue: (fields.issue && fields.issue.value.trim()) || '',
      labor: +(fields.labor && fields.labor.value)||0,
      parts: +(fields.parts && fields.parts.value)||0,
      paid: +(fields.paid && fields.paid.value)||0,
      status: (fields.status && fields.status.value) || 'work',
      notes: (fields.notes && fields.notes.value.trim()) || '',
      rating: state.stars||0,
      createdAt: Date.now()
    };
    const list = db.get();
    const i = list.findIndex(x=>x.id===payload.id);
    if(i>-1) list[i] = {...list[i], ...payload}; else list.unshift(payload);
    db.set(list); recordOp(i>-1?'update':'create', payload);
    toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); state.editId = payload.id; go('home');
  });

  safeOn(byId('btn-delete'), 'click', ()=>{
    const idEl = byId('f-id'); const id = idEl && idEl.value; if(!id) return;
    const list = db.get().filter(x=>x.id!==id); db.set(list); recordOp('delete',{id}); toast('–£–¥–∞–ª–µ–Ω–æ'); state.editId=null; go('home');
  });
  safeOn(byId('btn-cancel'), 'click', ()=>{ state.editId=null; go('home'); });

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å–∏–Ω–∫
  safeOn(byId('btn-save-config'), 'click', saveConfig);
  safeOn(byId('btn-sync-now'), 'click', syncNow);

  // PWA install
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; });
  safeOn(byId('btn-install'),'click', async ()=>{
    if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; }
    else toast('–ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Chrome –∏ –æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
  });

  // Clear cache via SW message
  safeOn(byId('btn-clear-cache'),'click', ()=>{
    if(navigator.serviceWorker && navigator.serviceWorker.controller){
      navigator.serviceWorker.controller.postMessage({type:'CLEAR_CACHE'});
      toast('–ó–∞–ø—Ä–æ—à–µ–Ω —Å–±—Ä–æ—Å –∫—ç—à–∞');
    }
  });

  // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
  go(state.page);
}

// SW —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./service-worker.js')
      .then(()=>console.log('SW registered'))
      .catch(err=>console.warn('SW failed', err));
  });
}

if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', init);
}else{ init(); }

// ====== SMOKE TESTS ======
(function tests(){
  const log = console.log.bind(console);
  const assert = (cond, msg) => cond ? log('‚úÖ', msg) : console.error('‚ùå', msg);
  const ex = compute({labor:2000, parts:1500, paid:500});
  assert(ex.total===3500 && ex.debt===3000 && ex.rest===3000, 'compute(): –±–∞–∑–æ–≤–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞');
  const sample = {id:'#123456', name:'–¢–µ—Å—Ç –ò–º—è', phone:'+7000', device:'Pixel 6'};
  assert(matchQuery(sample,'—Ç–µ—Å—Ç'), 'matchQuery(): –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ –≤ –∏–º–µ–Ω–∏');
  assert(matchQuery(sample,'#123'), 'matchQuery(): –ø—Ä–µ—Ñ–∏–∫—Å ID');
  assert(matchQuery(sample,'7000'), 'matchQuery(): —Ü–∏—Ñ—Ä—ã –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ');
  assert(!!byId('q'), '#q –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
  assert($$('.tab').length>=6, '–≤–∫–ª–∞–¥–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç');
  assert(!!byId('pages'), '#pages –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
  const prev = state.page; go('debts');
  assert(byId('page-debts').classList.contains('active'), 'go(): –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –î–æ–ª–∂–Ω–∏–∫–∏');
  go(prev);
})();
</script>
</body>
</html>
