(()=>{"use strict";window.__MiniCRMv2BootOK=!0;const e=(e,t=document)=>t.querySelector(e),t=(e,t=document)=>Array.from(t.querySelectorAll(e)),n=e=>document.getElementById(e),a=(e,t,n)=>e&&e.addEventListener(t,n),s=e=>new Intl.NumberFormat("ru-RU").format(Math.round(Number(e||0))),o=e=>s(e)+" ‚ÇΩ",i=e=>Math.ceil(e/864e5),l=()=>"#"+Math.floor(1e5+899999*Math.random()),r=e=>(null==e?"":String(e)).toLowerCase().replace(/[\s\u00A0\-\u2010\u2011()]/g,"");function d(e){const t=new Date(e),n=["–≤—Å","–ø–Ω","–≤—Ç","—Å—Ä","—á—Ç","–ø—Ç","—Å–±"][t.getDay()],a=t.toLocaleDateString("ru-RU",{month:"long"});return`${t.getDate()} ${a} ${n} ${t.getFullYear()} –≥–æ–¥–∞`}function c(e){const t=n("toast");t&&(t.textContent=e,t.classList.add("show"),setTimeout((()=>t.classList.remove("show")),1400))}const u={base:"mcrm.v2",lic:"mcrm.lic.v2",users:"mcrm.users",session:"mcrm.ses",profiles:"mcrm.profiles",cur:"mcrm.cur"};function m(){const e=localStorage.getItem(u.cur)||"default";return`${u.base}:${e}`}const g={get(){try{return JSON.parse(localStorage.getItem(m()))||[]}catch(e){return[]}},set(e){localStorage.setItem(m(),JSON.stringify(e||[]))}};function p(){let e=[];try{e=JSON.parse(localStorage.getItem(u.profiles)||"[]")}catch(e){}return Array.isArray(e)&&e.length||(e=["default"],localStorage.setItem(u.profiles,JSON.stringify(e)),localStorage.setItem(u.cur,"default")),e}function h(){const t=n("profile");if(!t)return;const a=p(),s=localStorage.getItem(u.cur)||"default";t.innerHTML=a.map((e=>`<option value="${e}" ${e===s?"selected":""}>${e}</option>`)).join("")}function v(){const e=localStorage.getItem(u.cur)||"default";return`${u.users}.${e}`}function y(){const e=localStorage.getItem(u.cur)||"default";return`${u.session}.${e}`}async function f(e){const t=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function b(){try{const e=JSON.parse(localStorage.getItem(v())||"[]");return Array.isArray(e)?e:[]}catch(e){return[]}}
function S(e){localStorage.setItem(v(),JSON.stringify(e||[]))}function L(){try{const e=JSON.parse(sessionStorage.getItem(y())||"null");return e&&e.ok?e:null}catch(e){return null}}function E(e){sessionStorage.setItem(y(),JSON.stringify(e))}function w(){sessionStorage.removeItem(y())}const k={key:"mcrm.lic.v2"};function x(){try{return JSON.parse(localStorage.getItem(k.key))||{trialStart:null,validUntil:null,key:"",sig:""}}catch(e){return{trialStart:null,validUntil:null,key:"",sig:""}}}function O(e){localStorage.setItem(k.key,JSON.stringify(e))}const C="-----BEGIN PUBLIC KEY-----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE2Qd+Jp1rXyQqg0w9a0m5qgI0mQf+\nqkQ3z1b3m3Jv9T1b1i0e3Ck6e2Jq5p1wM9uI6O8sC6v2k7dB8v1ZQ5Ck1Q==\n-----END PUBLIC KEY-----";function q(e){const t=e.replace(/-----[^-]+-----/g,"").replace(/\s+/g,"");return function(e){const t=atob(e),n=new Uint8Array(t.length);for(let a=0;a<t.length;a++)n[a]=t.charCodeAt(a);return n.buffer}(t)}async function T(){try{return await crypto.subtle.importKey("spki",q(C),{name:"ECDSA",namedCurve:"P-256"},!0,["verify"])}catch(e){return null}}async function P(e,t){try{const n=await T();if(!n)return!1;const a=new TextEncoder().encode(e),s=Uint8Array.from(atob(t),(e=>e.charCodeAt(0)));return await crypto.subtle.verify({name:"ECDSA",hash:"SHA-256"},n,s,a)}catch(e){return!1}}function $(){const e=x(),t=Date.now();let n="blocked",a="–ù–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏",s=0;return e.validUntil&&e.validUntil>t?(n="licensed",s=i(e.validUntil-t),a="–õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–Ω–∞: –æ—Å—Ç–∞–ª–æ—Å—å "+s+" –¥."):e.trialStart&&e.trialStart+6048e5>t?(n="trial",s=i(e.trialStart+6048e5-t),a="–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥: –æ—Å—Ç–∞–ª–æ—Å—å "+s+" –¥."):(n="blocked",a="–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω."),{status:n,txt:a,left:s}}function A(){return"blocked"!==$().status}function N(){const e=x();e.trialStart?(c("–ü—Ä–æ–±–Ω—ã–π —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"),0):(e.trialStart=Date.now(),O(e),void I())}async function D(e){try{const t=JSON.parse(e),{key:n,validUntil:a,sig:s}=t||{};if(!n||!a||!s)return c("–ù–µ–≤–µ—Ä–Ω—ã–π JSON –ª–∏—Ü–µ–Ω–∑–∏–∏"),!1;const o=JSON.stringify({key:n,validUntil:a}),i=await P(o,s);if(!i)return c("–ü–æ–¥–ø–∏—Å—å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞"),!1;const l=x();return l.validUntil&&a<l.validUntil?(c("–°–æ–∫—Ä–∞—Ç–∏—Ç—å —Å—Ä–æ–∫ –Ω–µ–ª—å–∑—è"),!1):(l.key=n,l.validUntil=a,l.sig=s,O(l),I(),c("–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞"),!0)}catch(e){return c("–û—à–∏–±–∫–∞ JSON"),!1}}function j(e,t=7){if(!e||e.length<6)return c("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"),!1;const n=x(),a=Date.now()+864e5*t;return n.validUntil&&a>n.validUntil?(c("–ö–æ–¥ –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –¥–æ–ª—å—à–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ"),!1):(n.key=(n.key||"ACCESS")+"-LOCAL",n.validUntil=Math.max(n.validUntil||0,a),O(n),I(),c("–ö–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω"),!0)}function H(){const e=x();e.validUntil=Date.now()-1e3,O(e),I()}function I(){const e=n("lic-banner"),t=$();if(e&&(e.style.display="block",e.textContent=t.txt,e.className="banner "+("licensed"===t.status?"ok":"trial"===t.status?"warn":"block")),n("acc-lic-state")&&(n("acc-lic-state").textContent=t.txt),n("blocker")){const e=!A()&&-1===["about","accounts"].indexOf(M.page);n("blocker").style.display=e?"flex":"none",n("blocker-msg")&&(n("blocker-msg").textContent=t.txt)}}
const R={links:{P1M:"#",P3M:"#",P12M:"#"},redeem:"/api/license/redeem"};async function U(){var e,t;const a=(null===(e=n("pay-proof"))||void 0===e?void 0:e.value)||"",s=(null===(t=n("plan"))||void 0===t?void 0:t.value)||"P1M",i=n("redeem-msg");if(!a)return void(i.textContent="–í–≤–µ–¥–∏—Ç–µ TxID/–∫–æ–¥ –∏–∑ –±–∞–Ω–∫–∞");try{const e={key:"URK-"+s+"-"+a.slice(-6),validUntil: Date.now()+2592e6,sig:"INVALID_SIG"};i.textContent="–õ–∏—Ü–µ–Ω–∑–∏—è –ø–æ–ª—É—á–µ–Ω–∞. –í—Å—Ç–∞–≤—å—Ç–µ JSON –Ω–∏–∂–µ –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ.",n("lic-json").value=JSON.stringify(e)}catch(e){i.textContent="–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏"}}function B(e){const t=+e.labor||0,n=+e.parts||0,a=+e.paid||0,s=t+n,o=Math.max(0,s-a),l=e.dueAt?+e.dueAt:e.createdAt?+e.createdAt+2592e5:Date.now(),r=o>0&&Date.now()>l?i(Date.now()-l):0;return{total:s,debt:o,dueAt:l,overdueDays:r}}function F(e,t){if(!t)return!0;const n=r([e.name,e.phone,e.device,e.id].join(" ")),a=r(t);return n.includes(a)||n.startsWith(a)}function G(e){let t=0,n=0,a=0,s=0,o=0,i=0;return e.forEach((e=>{const t=B(e);a+=t.debt,n+=+e.paid||0,s+=t.total,o+="work"===e.status?1:0,i+="done"===e.status?1:0,t.debt>0&&(0)})),{totalDebt:a,totalPaid:n,totalSum:s,inWork:o,done:i,debtors:e.filter((e=>B(e).debt>0)).length,count:e.length}}let M={page:"home",query:"",editId:null,viewId:null,stars:0,auth:{ok:!1,role:"guest",name:"–ì–æ—Å—Ç—å"}},V={};function _(e){const t=B(e),n=(e.phone||"").replace(/[^\d+]/g,""),a="done"===e.status?"dim-done":t.debt>0?"glow-red":"glow-green",s=t.debt>0?`‚Ä¢ –ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${t.overdueDays} –¥–Ω.`:"‚Ä¢ –ë–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–∫–∏",i="‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".split("").map(((t,n)=>`<span class="star ${n<(e.rating||0)?"filled":""}">‚òÖ</span>`)).join("");return`
  <div class="card ${a}" data-id="${e.id}">
    <div class="row">
      <div class="title">${e.name} <span class="muted">${e.id}</span></div>
      <div class="stars" aria-hidden="true">${i}</div>
    </div>
    <div class="row small" style="margin-top:6px">
      <a class="phone" href="tel:${n}">üìû ${e.phone||""}</a>
      <span>‚Ä¢ ${e.device||""}</span>
      <span>${s}</span>
    </div>
    <div class="chips">
      <span class="chip">–û–±—Ä–∞—â–µ–Ω–∏–µ: ${d(e.createdAt||Date.now())}</span>
      <span class="chip">–†–∞–±–æ—Ç–∞: ${o(e.labor||0)}</span>
      <span class="chip">–î–µ—Ç–∞–ª–∏: ${o(e.parts||0)}</span>
      <span class="chip"><b>–ò—Ç–æ–≥–æ: ${o(t.total)}</b></span>
      ${t.debt>0?`<span class="chip bad"><b>–î–æ–ª–≥: ${o(t.debt)}</b></span>`:`<span class="chip ok">–û–ø–ª–∞—á–µ–Ω–æ: ${o(e.paid||0)}</span>`}
      <span class="chip ${"done"===e.status?"ok":"warn"}">${"done"===e.status?"–ó–∞–≤–µ—Ä—à—ë–Ω":"–í —Ä–∞–±–æ—Ç–µ"}</span>
    </div>
    <div class="actions">
      <button class="btn" data-act="call">–í—ã–∑–≤–∞—Ç—å</button>
      <button class="btn" data-act="done">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <button class="btn primary" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
  </div>`}function z(e){return`<div class="card"><div class="muted">${e}</div></div>`}function J(e){const t=G(e),a=n("home-kpis");a&&(a.innerHTML=`
  <div class="kpi"><h3>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3><b>${t.count}</b><div class="small">–í —Ä–∞–±–æ—Ç–µ: ${t.inWork} ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${t.done}</div></div>
  <div class="kpi"><h3>–§–∏–Ω–∞–Ω—Å—ã</h3><b>${o(t.totalPaid)} / ${o(t.totalSum)}</b><div class="small">–û–±—â–∏–π –¥–æ–ª–≥: <b style="color:var(--warn)">${o(t.totalDebt)}</b></div></div>`)}function K(){const n=g.get(),a=n.filter((e=>F(e,M.query))),s=e("#stat"),i=G(a);s&&(s.textContent=`${i.count} ‚Ä¢ –ø—Ä–æ—Å—Ä–æ—á–∫–∞ ${i.debtors} ‚Ä¢ –≤ —Ä–∞–±–æ—Ç–µ ${i.inWork}`),J(a);const l=[...a].sort(((e,t)=>{const n=B(e),a=B(t),s=n.debt>0,o=a.debt>0;if(s!==o)return(o?1:0)-(s?1:0);if(s&&o&&a.overdueDays!==n.overdueDays)return a.overdueDays-n.overdueDays;return e.status!==t.status?"work"===e.status?-1:1:(t.createdAt||0)-(e.createdAt||0)})),r=n=>{const a=e(n);a&&(a.innerHTML=l.map(_).join("")||z("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞."))};r("#home-list");const d=a.filter((e=>B(e).debt>0));(e=>{const t=e.reduce(((e,t)=>e+B(t).debt),0),a=n("debts-summary");a&&(a.innerHTML=`<div class="card glow-red"><div class="title">–ü—Ä–æ—Å—Ä–æ—á–∫–∞ ‚Äî —Å–≤–æ–¥–∫–∞</div><div class="chips"><span class="chip bad">–í—Å–µ–≥–æ –¥–æ–ª–≥: ${o(t)}</span><span class="chip">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${e.length}</span></div></div>`)})((d));const c=n=>{const a=e(n);a&&(a.innerHTML=d.map(_).join("")||z("–ù–µ—Ç –¥–æ–ª–∂–Ω–∏–∫–æ–≤ üéâ"))};c("#debts-list");const u=n=>{const a=e(n);a&&(a.innerHTML=a?a.innerHTML:a)};((n=>{const t=e(n);t&&(t.innerHTML=a.filter((e=>"work"===e.status)).map(_).join("")||z("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–±–æ—Ç"))})("#work-list"),((n=>{const t=e(n);t&&(t.innerHTML=a.filter((e=>"done"===e.status)).map(_).join("")||z("–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö"))})("#done-list")),u)}function Q(e,t){e&&(e.innerHTML="‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".split("").map(((e,n)=>`<span class="star ${n<t?"filled":""}" data-val="${n+1}">‚òÖ</span>`)).join(""))}function W(e){const t={id:n("f-id"),name:n("f-name"),phone:n("f-phone"),device:n("f-device"),issue:n("f-issue"),labor:n("f-labor"),parts:n("f-parts"),paid:n("f-paid"),status:n("f-status"),notes:n("f-notes"),due:n("f-due")},a=n("btn-delete"),s=n("f-stars");if(!e){n("form")&&n("form").reset(),M.stars=0,Q(s,0),t.due&&(t.due.valueAsDate=new Date(Date.now()+2592e5)),a&&(a.style.display="none");return}const o=g.get().find((t=>t.id===e));if(!o){W(null);return}t.id.value=o.id,t.name.value=o.name||"",t.phone.value=o.phone||"",t.device.value=o.device||"",t.issue.value=o.issue||"",t.labor.value=o.labor||0,t.parts.value=o.parts||0,t.paid.value=o.paid||0,t.status.value=o.status||"work",t.notes.value=o.notes||"",t.due&&o.dueAt&&(()=>{const e=new Date(o.dueAt);t.due.valueAsDate=new Date(e.getFullYear(),e.getMonth(),e.getDate())})(),M.stars=o.rating||0,Q(s,M.stars),a&&(a.style.display="block")}function X(){const e=n("view-wrap");if(!e)return;const t=g.get().find((e=>e.id===M.viewId));if(!t){e.innerHTML=z("–ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");return}const a=B(t),s=(t.phone||"").replace(/[^\d+]/g,""),i="‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".split("").map(((e,n)=>`<span class="star ${n<(t.rating||0)?"filled":""}">‚òÖ</span>`)).join("");a.debt>0?`–ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${a.overdueDays} –¥–Ω.`:"–ë–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–∫–∏";const l="done"===t.status?"dim-done":a.debt>0?"glow-red":"glow-green";e.innerHTML=`
  <div class="card ${l}">
    <div class="row"><div class="title">${t.name} <span class="muted">${t.id}</span></div><div class="stars" aria-hidden="true">${i}</div></div>
    <div class="row small" style="margin-top:6px"><a class="phone" href="tel:${s}">üìû ${t.phone||""}</a><span>‚Ä¢ ${t.device||""}</span><span>‚Ä¢ ${a.debt>0?`–ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${a.overdueDays} –¥–Ω.`:"–ë–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–∫–∏"}</span></div>
    <div class="chips" style="margin-top:6px">
      <span class="chip">–û–±—Ä–∞—â–µ–Ω–∏–µ: ${d(t.createdAt||Date.now())}</span>
      <span class="chip">–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã: ${t.dueAt?d(t.dueAt):"–Ω–µ —É–∫–∞–∑–∞–Ω"}</span>
      <span class="chip">–°—Ç–∞—Ç—É—Å: ${"done"===t.status?"–ó–∞–≤–µ—Ä—à—ë–Ω":"–í —Ä–∞–±–æ—Ç–µ"}</span>
      <span class="chip">–†–∞–±–æ—Ç–∞: ${o(t.labor||0)}</span>
      <span class="chip">–î–µ—Ç–∞–ª–∏: ${o(t.parts||0)}</span>
      <span class="chip"><b>–ò—Ç–æ–≥–æ: ${o(a.total)}</b></span>
      ${a.debt>0?`<span class="chip bad"><b>–î–æ–ª–≥: ${o(a.debt)}</b></span>`:`<span class="chip ok">–û–ø–ª–∞—á–µ–Ω–æ: ${o(t.paid||0)}</span>`}
    </div>
    ${t.issue?`<div class="small" style="margin-top:10px"><b>–ü—Ä–æ–±–ª–µ–º–∞:</b> ${t.issue}</div>`:""}
    ${t.notes?`<div class="small" style="margin-top:6px"><b>–ó–∞–º–µ—Ç–∫–∞ –º–∞—Å—Ç–µ—Ä–∞:</b> ${t.notes}</div>`:""}
    <div class="actions" style="margin-top:12px">
      <button class="btn" data-v="call">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
      <button class="btn" data-v="wa">WhatsApp</button>
      <button class="btn" data-v="copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª.</button>
    </div>
    <div class="actions" style="margin-top:8px">
      <button class="btn link" data-v="share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      <button class="btn primary" data-v="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>`}function Y(e){"about"!==e&&"accounts"!==e&&!A()&&(e="accounts"),M.page=e,t(".tab").forEach((t=>t.classList.toggle("active",t.dataset.page===e))),t(".navbtn").forEach((t=>t.classList.toggle("active",t.dataset.page===e))),t(".page").forEach((t=>t.classList.toggle("active",t.id===`page-${e}`))),K(),"edit"===e&&W(M.editId),"view"===e&&X(),"accounts"===e&&Z(),I()}function Z(){const e=n("acc-users");if(!e)return;const t=b();M.auth.ok&&"admin"===M.auth.role?e.innerHTML=t.map((e=>`
  <div class="card" data-uid="${e.id}">
    <div class="grid2">
      <div class="field"><label>–ò–º—è</label><input value="${e.name}" data-f="name"></div>
      <div class="field"><label>–†–æ–ª—å</label><select data-f="role"><option value="admin" ${"admin"===e.role?"selected":""}>admin</option><option value="editor" ${"editor"===e.role?"selected":""}>editor</option><option value="guest" ${"guest"===e.role?"selected":""}>guest</option></select></div>
    </div>
    <div class="grid2" style="margin-top:6px">
      <input placeholder="–ù–æ–≤—ã–π –ü–ò–ù (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" data-f="pin" inputmode="numeric">
      <button class="btn" data-act="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="actions" style="margin-top:6px"><button class="btn danger" data-act="del">–£–¥–∞–ª–∏—Ç—å</button></div>
  </div>`)).join(""):'<div class="small">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.</div>',a(e,"click",(async s=>{const o=s.target.closest(".card");if(!o)return;const i=o.dataset.uid,l=s.target.closest("[data-act]")?.getAttribute("data-act");let r=b();const d=r.findIndex((e=>e.id===i));if(!(d<0))if("save"===l){const e=o.querySelector('[data-f="name"]').value.trim()||r[d].name,t=o.querySelector('[data-f="role"]').value||r[d].role,n=o.querySelector('[data-f="pin"]').value.trim();r[d].name=e,r[d].role=t,n&&(r[d].pinHash=await f(n)),S(r),c("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ")}else"del"===l&&(r.length<=1?c("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ"):((r=r.filter((e=>e.id!==i))),S(r),c("–£–¥–∞–ª—ë–Ω"),Z()))}))}async function ee(){c("Sync pull: TODO")}async function te(){c("Sync push: TODO")}function ne(){let e=b();e.length||(e=[{id:"u-root",name:"–ê–¥–º–∏–Ω",role:"admin",pinHash:""}],S(e))}async function ae(){let e=b();if(!e.length)return ne(),ae();const t=e.map(((e,t)=>`${t+1}) ${e.name} [${e.role}]`)).join("\n"),a=prompt("–í–æ–π—Ç–∏ –∫–∞–∫:\n"+t+"\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:","1"),s=Math.max(1,Math.min(e.length,parseInt(a||"1",10)))-1,o=e[s],i=prompt("–í–≤–µ–¥–∏—Ç–µ –ü–ò–ù –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ¬´"+o.name+"¬ª (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç–æ, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):","");if(o.pinHash){const e=await f(i||"");if(e!==o.pinHash)return c("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù"),!1}return M.auth={ok:!0,role:o.role,name:o.name,uid:o.id},E(M.auth),c("–í—Ö–æ–¥: "+o.name+" ["+o.role+"]"),!0}function se(){return(function(){return!!(M.auth&&M.auth.ok&&("admin"===M.auth.role||"editor"===M.auth.role))})()||(c("–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥"),ae())}function oe(){const t=document.getElementById("app");t.innerHTML=`
  <div class="header">
    <div class="brand"><div class="dot"></div><h1>MiniCRM v2 ‚Äî –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è</h1></div>
    <div class="right">
      <select id="profile" class="select" title="–ü—Ä–æ—Ñ–∏–ª—å"></select>
      <button id="add-profile" class="iconbtn" title="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">Ôºã</button>
    </div>
  </div>

  <div class="header" style="gap:0;padding-top:0">
    <div class="search" style="width:100%">
      <input id="q" placeholder="–ü–æ–∏—Å–∫: –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –º–æ–¥–µ–ª—å, #ID‚Ä¶ (–ø–æ –±—É–∫–≤–∞–º/—Ü–∏—Ñ—Ä–∞–º)" autocomplete="off" />
      <div class="badge" id="stat">0 –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
    <button class="tab" data-page="debts">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</button>
    <button class="tab" data-page="work">–í —Ä–∞–±–æ—Ç–µ</button>
    <button class="tab" data-page="done">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
    <button class="tab" data-page="edit">–ù–æ–≤—ã–π/–ü—Ä–∞–≤–∫–∞</button>
    <button class="tab" data-page="view">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
    <button class="tab" data-page="accounts">–ê–∫–∫–∞—É–Ω—Ç—ã</button>
    <button class="tab" data-page="about">–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
  </div>

  <div class="banner" id="lic-banner"></div>

  <div class="pages" id="pages">
    <section class="page active" id="page-home">
      <div class="kpis" id="home-kpis"></div>
      <div id="home-list"></div>
    </section>

    <section class="page" id="page-debts">
      <div id="debts-summary"></div>
      <div id="debts-list"></div>
    </section>

    <section class="page" id="page-work"><div id="work-list"></div></section>
    <section class="page" id="page-done"><div id="done-list"></div></section>

    <section class="page" id="page-edit">
      <form class="form" id="form">
        <input type="hidden" id="f-id" />
        <div class="field"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input id="f-name" required /></div>
        <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="f-phone" inputmode="tel" placeholder="+7‚Ä¶" /></div>
        <div class="field"><label>–ú–æ–¥–µ–ª—å –∞–ø–ø–∞—Ä–∞—Ç–∞</label><input id="f-device" /></div>
        <div class="field"><label>–ü—Ä–æ–±–ª–µ–º–∞</label><textarea id="f-issue"></textarea></div>
        <div class="field"><label>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã ‚ÇΩ</label><input id="f-labor" type="number" inputmode="numeric" value="0" /></div>
        <div class="field"><label>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—á–∞—Å—Ç–µ–π ‚ÇΩ</label><input id="f-parts" type="number" inputmode="numeric" value="0" /></div>
        <div class="field"><label>–û–ø–ª–∞—á–µ–Ω–æ ‚ÇΩ</label><input id="f-paid" type="number" inputmode="numeric" value="0" /></div>
        <div class="field"><label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</label><input id="f-due" type="date" /></div>
        <div class="field"><label>–°—Ç–∞—Ç—É—Å</label>
          <select id="f-status">
            <option value="work">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
          </select>
        </div>
        <div class="field"><label>–ó–∞–º–µ—Ç–∫–∞ –º–∞—Å—Ç–µ—Ä–∞</label><textarea id="f-notes"></textarea></div>
        <div class="field"><label>–†–µ–π—Ç–∏–Ω–≥ –∫–ª–∏–µ–Ω—Ç–∞</label><div class="stars" id="f-stars"></div><div class="small">–∫–æ—Å–Ω–∏—Å—å –Ω—É–∂–Ω–æ–π –∑–≤–µ–∑–¥—ã</div></div>
        <div class="actions">
          <button type="button" class="btn ghost" id="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn primary" id="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <button type="button" class="btn danger" id="btn-delete" style="margin-top:6px">–£–¥–∞–ª–∏—Ç—å</button>
      </form>
    </section>

    <section class="page" id="page-view"><div id="view-wrap"></div></section>

    <section class="page" id="page-accounts">
      <div class="card">
        <div class="title">–õ–∏—Ü–µ–Ω–∑–∏—è</div>
        <div class="small" id="acc-lic-state">‚Äî</div>
        <div class="grid2" style="margin-top:10px">
          <button class="btn" id="acc-check-lic">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–Ω–ª–∞–π–Ω</button>
          <button class="btn" id="acc-disable-lic">–û—Ç–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>
      </div>
      <div class="card">
        <div class="title">–ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø–ª–∞—Ç—ã (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)</div>
        <div class="small">1) –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ ‚Üí 2) –û–ø–ª–∞—Ç–∏—Ç–µ ‚Üí 3) –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥/TxID ‚Üí 4) –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—É—é –ª–∏—Ü–µ–Ω–∑–∏—é (JSON) ‚Üí 5) –ö–ª–∏–µ–Ω—Ç –í–ï–†–ò–§–ò–¶–ò–†–£–ï–¢ –ø–æ–¥–ø–∏—Å—å –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º –∏ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç —Å—Ä–æ–∫.</div>
        <div class="grid2" style="margin-top:8px">
          <select id="plan" class="select">
            <option value="P1M">1 –º–µ—Å—è—Ü</option>
            <option value="P3M">3 –º–µ—Å—è—Ü–∞</option>
            <option value="P12M">12 –º–µ—Å—è—Ü–µ–≤</option>
          </select>
          <button class="btn primary" id="pay-open">–û–ø–ª–∞—Ç–∏—Ç—å</button>
        </div>
        <div class="grid2" style="margin-top:8px">
          <input id="pay-proof" placeholder="TxID/–ö–æ–¥ –æ—Ç –±–∞–Ω–∫–∞" />
          <button class="btn" id="redeem">–ü–æ–ª—É—á–∏—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é</button>
        </div>
        <div class="small" id="redeem-msg" style="margin-top:6px">‚Äî</div>
        <div class="grid2" style="margin-top:8px">
          <input id="lic-json" placeholder='–í—Å—Ç–∞–≤—å—Ç–µ JSON {"key","validUntil","sig"}' />
          <button class="btn" id="apply-lic">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å / –ü—Ä–æ–¥–ª–∏—Ç—å</button>
        </div>
      </div>
      <div class="card">
        <div class="title">–ö–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ (–æ—Ñ–ª–∞–π–Ω)</div>
        <div class="grid2" style="margin-top:8px">
          <input id="acc-access-code" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 19801980" />
          <button class="btn" id="acc-apply-code">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="small">–ö–æ–¥ –¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ñ–ª–∞–π–Ω‚Äë–¥–æ—Å—Ç—É–ø –∏ <b>–Ω–µ –º–æ–∂–µ—Ç</b> –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å –¥–æ–ª—å—à–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ —Å—Ä–æ–∫–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å—Ç—Ä–æ–µ–Ω–∞.</div>
      </div>
      <div class="card">
        <div class="title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div id="acc-users" class="form"></div>
        <div class="actions"><button class="btn" id="acc-add-user">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button></div>
      </div>
      <div class="card">
        <div class="title">–ë—ç–∫–∞–ø / –æ–±–º–µ–Ω / —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
        <div class="grid2" style="margin-top:8px">
          <button class="btn" id="acc-export-json">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
          <label class="btn" style="text-align:center;cursor:pointer"><input type="file" id="acc-import-json" accept="application/json" style="display:none">–ò–º–ø–æ—Ä—Ç JSON</label>
          <button class="btn" id="acc-share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          <button class="btn" id="acc-download">–°–∫–∞—á–∞—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
        </div>
        <div class="small" style="margin-top:6px">–û–Ω–ª–∞–π–Ω‚Äë—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –≤–∞—à–∏ Apps Script/Drive/Dropbox/OneDrive —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö <code>syncPull()</code>/<code>syncPush()</code> (–Ω–∏–∂–µ –≤ –∫–æ–¥–µ –æ—Ç–º–µ—á–µ–Ω–æ TODO).</div>
      </div>
    </section>

    <section class="page" id="page-about">
      <div class="card">
        <div class="logo"><div class="mark"></div>
          <div>
            <div class="title">–£–≥—Ä–∞–†–µ–º–ö–æ–º–ø ‚Äî MiniCRM v2</div>
            <div class="small">Android‚Äëfriendly, –æ—Ñ–ª–∞–π–Ω/–æ–Ω–ª–∞–π–Ω, –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é —Å–µ—Ä–≤–µ—Ä–∞</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="title">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</div>
        <ul class="small">
          <li>–ö–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤, –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–∫—Ä–∞—Å–Ω—ã–π –¥–æ–ª–∂–Ω–∏–∫, –∑–µ–ª—ë–Ω—ã–π –≤ —Ä–∞–±–æ—Ç–µ, –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é)</li>
          <li>–°—Ç—Ä–æ–∫–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–ü—Ä–æ—Å—Ä–æ—á–∫–∞: N –¥–Ω–µ–π¬ª, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ª–≥</li>
          <li>–î–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´2 –Ω–æ—è–±—Ä—è –≤—Å 2025 –≥–æ–¥–∞¬ª</li>
          <li>–ü–æ–∏—Å–∫ –ø–æ –±—É–∫–≤–∞–º/—Ü–∏—Ñ—Ä–∞–º: –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –º–æ–¥–µ–ª—å, #ID</li>
          <li>–ê–∫–∫–∞—É–Ω—Ç—ã: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ª–∏—Ü–µ–Ω–∑–∏–∏, –∫–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞</li>
          <li>–≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç/—à–∞—Ä–∏–Ω–≥, –∑–∞–¥–µ–ª –ø–æ–¥ –æ–Ω–ª–∞–π‚Äë—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é</li>
        </ul>
      </div>
    </section>
  </div>

  <div class="navbar" id="navbar">
    <div class="navrow">
      <button class="navbtn active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="navbtn" data-page="debts">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</button>
      <button class="navbtn" data-page="work">–í —Ä–∞–±–æ—Ç–µ</button>
      <button class="navbtn" data-page="edit">–ù–æ–≤—ã–π</button>
      <button class="navbtn" data-page="about">–û –ø—Ä–æ–≥—Ä.</button>
    </div>
  </div>

  <div class="toast" id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

  <div class="blocker" id="blocker">
    <div class="modal">
      <div class="title">–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</div>
      <div class="small" id="blocker-msg" style="margin:8px 0 12px">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç—ë–∫.</div>
      <div class="actions">
        <button class="btn primary" data-act="open-accounts">–ö –ª–∏—Ü–µ–Ω–∑–∏–∏</button>
        <button class="btn" data-act="open-about">–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
      </div>
    </div>
  </div>`;!function(){V={pages:n("pages"),tabs:n("tabs"),navbar:n("navbar"),q:n("q")},h(),a(n("profile"),"change",(e=>{localStorage.setItem(u.cur,e.target.value),c("–ü—Ä–æ—Ñ–∏–ª—å: "+e.target.value),M.auth={ok:!1,role:"guest",name:"–ì–æ—Å—Ç—å"},h(),K(),Y("home")})),a(n("add-profile"),"click",(()=>{const e=prompt("–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã):","user2");if(e){const t=p();t.includes(e)||(t.push(e),localStorage.setItem(u.profiles,JSON.stringify(t)),localStorage.setItem(u.cur,e),M.auth={ok:!1,role:"guest",name:"–ì–æ—Å—Ç—å"},h(),c("–î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å "+e),Y("home"))}})),a(V.q,"input",(()=>{M.query=V.q.value.trim(),K()}));const s=e=>{const t=e.target.closest("[data-page]");if(t){const n=t.getAttribute("data-page");"edit"===n&&(M.editId=null),Y(n)}};a(V.tabs,"click",s),a(V.navbar,"click",s);let o=null;const l=["home","debts","work","done","edit","view","accounts","about"];a(V.pages,"touchstart",(e=>{o=e.changedTouches[0].clientX})),a(V.pages,"touchend",(e=>{if(null==o)return;const t=e.changedTouches[0].clientX-o;if(o=null,!(Math.abs(t)<50)){let e=l.indexOf(M.page);t<0&&e<l.length-1&&Y(l[e+1]),t>0&&e>0&&Y(l[e-1])}})),a(V.pages,"click",(e=>{const t=e.target.closest(".card");if(!t)return;const n=t.dataset.id;if(!n)return;if(e.target.closest('[data-act="open"]'))return M.viewId=n,void Y("view");if(e.target.closest('[data-act="done"]')){if(!function(){return!!(M.auth&&M.auth.ok&&("admin"===M.auth.role||"editor"===M.auth.role))}()){se();return}const e=g.get(),t=e.findIndex((e=>e.id===n));return void(t>-1&&(e[t].status="done",g.set(e),c("–û—Ç–º–µ—á–µ–Ω–æ ¬´–ó–∞–≤–µ—Ä—à—ë–Ω¬ª"),K()))}e.target.closest('[data-act="call"]')?function(e){const t=g.get().find((t=>t.id===e));t&&(location.href="tel:"+(t.phone||"").replace(/[^\d+]/g,""))}(n):e.target.closest(".btn")||(M.viewId=n,Y("view"))})),a(n("page-view"),"click",(async e=>{var t;const a=null===(t	e.target.closest("[data-v]"))||void 0===t?void 0:t.getAttribute("data-v");if(!a)return;const s=g.get().find((e=>e.id===M.viewId));if(!s)return;const i=B(s),l=(s.phone||"").replace(/[^\d+]/g,"");"call"===a&&(location.href="tel:"+l),"wa"===a&&window.open("https://wa.me/"+l.replace(/^\+/,""),"_blank"),"copy"===a&&(await(async e=>{try{await navigator.clipboard.writeText(e),c("–¢–µ–ª–µ—Ñ–æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω")}catch(e){c("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å")}})(s.phone||"")),"share"===a&&function(e,t){const n=`${e.name} ${e.id}\n${e.device||""}\n–ò—Ç–æ–≥–æ: ${o(t.total)} ‚Ä¢ –û–ø–ª–∞—á–µ–Ω–æ: ${o(e.paid||0)} ‚Ä¢ –î–æ–ª–≥: ${o(t.debt)}\n–¢–µ–ª: ${e.phone||""}`;navigator.share?async function(e){try{await navigator.share(e)}catch(e){}}({title:"–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞",text:n}):async function(e){try{await navigator.clipboard.writeText(e),c("–î–µ—Ç–∞–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã")}catch(e){c("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é")}}(n)}(s,i),"edit"===a&&(M.editId=s.id,Y("edit"))})),a(n("page-edit"),"click",(e=>{const t=e.target.closest("#f-stars .star");t&&(M.stars=+t.dataset.val||0,Q(n("f-stars"),M.stars))})),a(n("form"),"submit",(e=>{if(e.preventDefault(),!function(){return!!(M.auth&&M.auth.ok&&("admin"===M.auth.role||"editor"===M.auth.role))}()){if(!se())return}const t={id:n("f-id"),name:n("f-name"),phone:n("f-phone"),device:n("f-device"),issue:n("f-issue"),labor:n("f-labor"),parts:n("f-parts"),paid:n("f-paid"),status	n("f-status"),notes:n("f-notes"),due:n("f-due")},a={id:t.id.value||l(),name:(t.name.value||"").trim(),phone:(t.phone.value||"").trim(),device:(t.device.value||"").trim(),issue:(t.issue.value||"").trim(),labor:+(t.labor.value||0),parts:+(t.parts.value||0),paid:+(t.paid.value||0),status:t.status.value||"work",notes:(t.notes.value||"").trim(),rating:M.stars||0,createdAt:Date.now(),dueAt:t.due.valueAsDate?new Date(t.due.valueAsDate.getFullYear(),t.due.valueAsDate.getMonth(),t.due.valueAsDate.getDate()).getTime():Date.now()+2592e5},s=g.get(),o=s.findIndex((e=>e.id===a.id));o>-1?s[o]={...s[o],...a}:s.unshift(a),g.set(s),c("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"),M.editId=a.id,M.viewId=a.id,Y("view")})),a(n("btn-delete"),"click",(()=>{if(!(M.auth&&M.auth.ok&&"admin"===M.auth.role))return void c("–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É");const e	n("f-id").value;if(!e)return;const t=g.get().filter((t=>t.id!==e));g.set(t),c("–£–¥–∞–ª–µ–Ω–æ"),M.editId=null,Y("home")})),a(n("btn-cancel"),"click",(()=>{M.editId=null,Y("home")})),a(n("blocker"),"click",(e=>{const t=e.target.closest("[data-act]")?.getAttribute("data-act");t&&("open-accounts"===t&&Y("accounts"),"open-about"===t&&Y("about"))})),a(n("acc-check-lic"),"click",(()=>{I(),c("–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω")})),a(n("acc-disable-lic"),"click",(()=>{H(),c("–î–æ—Å—Ç—É–ø –æ—Ç–∫–ª—é—á—ë–Ω")})),a(n("pay-open"),"click",(()=>{var e;const t=(null===(e=n("plan"))||void 0===e?void 0:e.value)||"P1M",a=R.links[t];a&&"#"!==a?window.open(a,"_blank"):c("URL –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")})),a(n("redeem"),"click",U),a(n("apply-lic"),"click",(()=>{D(n("lic-json").value.trim())})),a(n("acc-apply-code"),"click",(=>{j(n("acc-access-code").value.trim(),7)})),a(n("acc-add-user"),"click",(function(){if(!(M.auth&&M.auth.ok&&"admin"===M.auth.role))return void c("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω");(async()=>{const e=prompt("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:","–ù–æ–≤—ã–π")||"–ù–æ–≤—ã–π",t=prompt("–†–æ–ª—å (admin/editor/guest):","editor")||"editor",n=prompt("–ü–ò–ù (4‚Äì32):","1234")||"1234";if(n.length<4||n.length>32)return void c("–ü–ò–ù 4‚Äì32");const a=b();a.push({id:"u-"+Date.now(),name:e,role:["admin","editor","guest"].includes	t)?t:"editor",pinHash:await f(n)}),S(a),c("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω"),Z()})()})),a(n("acc-export-json"),"click",(async()=>{try{await navigator.clipboard.writeText(JSON.stringify(g.get(),null,2)),c("–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä")}catch(e){c("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å")}})),a(n("acc-import-json"),"change",(async e=>{const t=e.target.files?.[0];if(!t)return;const n=await t.text();try{const e=JSON.parse(n);if(!Array.isArray(e))throw new Error("not array");if(!confirm("–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É –Ω–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—É—é?"))return;g.set(e),c("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω"),K()}catch(e){c("–û—à–∏–±–∫–∞ JSON")}e.target.value=""})),a(n("acc-share"),"click",(async()=>{const e=JSON.stringify(g.get());navigator.share?await async function(e){try{await navigator.share(e)}catch(e){}}({title:"MiniCRM export",text:e}):await async function(e){try{await navigator.clipboard.writeText(e),c("–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω")}catch(e){c("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é")}}(e)})),a(n("acc-download"),"click",(()=>{const e=new Blob([JSON.stringify(g.get(),null,2)],{type:"application/json"}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download="minicrm-export.json",t.click(),URL.revokeObjectURL(t.href)})),ne(),Q(n("f-stars"),0),I(),K(),A()||Y("accounts"),ie()}();function ie(){try{const e={labor:2e3,parts:1e3,paid:500,createdAt:0,dueAt:Date.now()-432e6},t=B(e);!function(e,t){t?console.log("‚úÖ",e):console.error("‚ùå",e)}("compute: total=3000",3e3===t.total),function(e,t){t?console.log("‚úÖ",e):console.error("‚ùå",e)}("compute: debt=2500",2500===t.debt),function(e,t){t?console.log("‚úÖ",e):console.error("‚ùå",e)}("compute: overdue >=5",t.overdueDays>=5);const n={name:"–ò–≤–∞–Ω",phone:"+7 900 111-22-33",device:"iPhone",id:"#123"};!function(e,t){t?console.log("‚úÖ",e):console.error("‚ùå",e)}("matchQuery: by name/phone/id",F(n,"–∏–≤")&&F(n,"900111")&&F(n,"#123"));const a=[{id:"#1",name:"A",labor:0,parts:0,paid:0,status:"work",createdAt:1},{id:"#2",name:"B",labor:100,parts:0,paid:0,status:"work",createdAt:2,dueAt:Date.now()-2592e5},{id:"#3",name:"C",labor:100,parts:0,paid:50,status:"work",createdAt:3,dueAt:Date.now()-1728e5}],s=[...a].sort(((e,t)=>{const n=B(e),a=B(t),s=n.debt>0,o=a.debt>0;if(s!==o)return(o?1:0)-(s?1:0);if(s&&o){if(a.overdueDays!==n.overdueDays)return a.overdueDays-n.overdueDays}return e.status!==t.status?"work"===e.status?-1:1:(t.createdAt||0)-(e.createdAt||0)}));!function(e,t){t?console.log("‚úÖ",e):console.error("‚ùå",e)}("sorting: debtors first by overdue","#2"===s[0].id&&"#3"===s[1].id),console.log("‚Äî –°–∞–º–æ—Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã ‚Äî")}catch(e){console.error("–¢–µ—Å—Ç —É–ø–∞–ª:",e)}}}();